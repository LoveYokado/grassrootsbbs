{% extends "admin/base_admin.html" %}
{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<h1>{{ title }}: {{ user.name }}</h1>

<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-user-edit me-1"></i>
        User Details
    </div>
    <div class="card-body">
        <form method="post">
            <div class="mb-3">
                <label for="name" class="form-label">{{ g.texts.get('admin_edit_user', {}).get('username_label',
                    'Username (read-only)') }}</label>
                <input type="text" class="form-control" id="name" name="name" value="{{ user.name }}" readonly>
            </div>
            <div class="mb-3">
                <label for="level" class="form-label">{{ g.texts.get('admin_edit_user', {}).get('level_label', 'Level
                    (0-5)') }}</label>
                <input type="number" class="form-control" id="level" name="level" value="{{ user.level }}" min="0"
                    max="5" required>
            </div>
            <div class="mb-3">
                <label for="email" class="form-label">{{ g.texts.get('admin_edit_user', {}).get('email_label', 'Email')
                    }}</label>
                <input type="email" class="form-control" id="email" name="email" value="{{ user.email or '' }}">
            </div>
            <div class="mb-3">
                <label for="comment" class="form-label">{{ g.texts.get('admin_edit_user', {}).get('comment_label',
                    'Comment') }}</label>
                <input type="text" class="form-control" id="comment" name="comment" value="{{ user.comment or '' }}">
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">{{ g.texts.get('admin_edit_user', {}).get('password_label',
                    'New Password (leave blank to keep current)') }}</label>
                <input type="password" class="form-control" id="password" name="password" autocomplete="new-password">
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">{{ g.texts.get('admin_edit_user', {}).get('save_button',
                    'Save Changes') }}</button>
                <a href="{{ url_for('admin.user_management', tab='list') }}" class="btn btn-secondary">{{
                    g.texts.get('admin_edit_user',
                    {}).get('cancel_button', 'Cancel') }}</a>
            </div>
        </form>
    </div>
</div>

<!-- Passkeyセクション -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-key me-1"></i>
        {{ g.texts.get('admin_edit_user', {}).get('passkeys_header', 'Passkeys') }}
    </div>
    <div class="card-body">
        {% if passkeys %}
        <div class="table-responsive">
            <table class="table table-bordered" width="100%" cellspacing="0">
                <thead>
                    <tr>
                        <th>{{ g.texts.get('admin_edit_user', {}).get('table_nickname', 'Nickname') }}</th>
                        <th>{{ g.texts.get('admin_edit_user', {}).get('table_registered', 'Registered At') }}</th>
                        <th>{{ g.texts.get('admin_edit_user', {}).get('table_last_used', 'Last Used') }}</th>
                        <th>{{ g.texts.get('admin_edit_user', {}).get('table_actions', 'Actions') }}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for key in passkeys %}
                    <tr>
                        <td>{{ key.nickname or '(No Nickname)' }}</td>
                        <td>{{ key.created_at | timestamp_to_datetime }}</td>
                        <td>{{ key.last_used_at | timestamp_to_datetime if key.last_used_at else
                            g.texts.get('admin_edit_user', {}).get('never', 'Never') }}</td>
                        <td>
                            <form
                                action="{{ url_for('admin.delete_user_passkey', user_id=user.id, passkey_id=key.id) }}"
                                method="post"
                                onsubmit="return confirm('{{ g.texts.get('admin_edit_user', {}).get('delete_confirm', 'Are you sure you want to delete this Passkey?') }}');">
                                <button type="submit" class="btn btn-danger btn-sm">{{ g.texts.get('admin_edit_user',
                                    {}).get('action_delete', 'Delete') }}</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p>{{ g.texts.get('admin_edit_user', {}).get('no_passkeys', 'This user has no registered Passkeys.') }}</p>
        {% endif %}
    </div>
</div>
{% endblock %}