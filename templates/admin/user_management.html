{% extends "admin/base_admin.html" %}

{% block title %}User Management{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<h1>User Management</h1>

<ul class="nav nav-tabs" id="userManagementTab" role="tablist">
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if tab == 'list' %}active{% endif %}" id="list-tab"
            href="{{ url_for('admin.user_management', tab='list') }}" role="tab">User List</a>
    </li>
    <li class="nav-item" role="presentation">
        <a class="nav-link {% if tab == 'activity' %}active{% endif %}" id="activity-tab"
            href="{{ url_for('admin.user_management', tab='activity') }}" role="tab">User Activity</a>
    </li>
</ul>

<div class="tab-content" id="userManagementTabContent" style="padding-top: 20px;">
    {# --- User List Tab --- #}
    <div class="tab-pane fade {% if tab == 'list' %}show active{% endif %}" id="list" role="tabpanel">
        <p>Displays a list of all registered users. You can search for users by name or email.</p>

        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
            <form method="get" action="{{ url_for('admin.user_management') }}" class="d-flex flex-wrap gap-2">
                <input type="hidden" name="tab" value="list">
                <div>
                    <input type="text" name="q" value="{{ search_term or '' }}" placeholder="Search by name or email..."
                        class="form-control">
                </div>
                <div class="form-actions d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Search</button>
                    <a href="{{ url_for('admin.user_management', tab='list') }}" class="btn btn-secondary">Clear</a>
                </div>
            </form>
            <a href="{{ url_for('admin.new_user') }}" class="btn btn-success">Add New User</a>
        </div>

        {% include 'admin/_pagination.html' %}
        <div class="table-responsive">
            <table class="table" style="margin-top: 1em; margin-bottom: 1em;">
                <thead>
                    <tr>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='id', order=next_order if sort_by == 'id' else 'asc', q=search_params.q, per_page=search_params.per_page) }}">ID
                                {% if sort_by == 'id' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='name', order=next_order if sort_by == 'name' else 'asc', q=search_params.q, per_page=search_params.per_page) }}">Name
                                {% if sort_by == 'name' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='level', order=next_order if sort_by == 'level' else 'asc', q=search_params.q, per_page=search_params.per_page) }}">Level
                                {% if sort_by == 'level' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='email', order=next_order if sort_by == 'email' else 'asc', q=search_params.q, per_page=search_params.per_page) }}">Email
                                {% if sort_by == 'email' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th>Comment</th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='registdate', order=next_order if sort_by == 'registdate' else 'desc', q=search_params.q, per_page=search_params.per_page) }}">Registered
                                {% if sort_by == 'registdate' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='list', sort_by='lastlogin', order=next_order if sort_by == 'lastlogin' else 'desc', q=search_params.q, per_page=search_params.per_page) }}">Last
                                Login {% if sort_by == 'lastlogin' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a>
                        </th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.name }}</td>
                        <td>{{ user.level }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.comment }}</td>
                        <td>{{ user.registdate|int|timestamp_to_datetime if user.registdate else 'N/A' }}</td>
                        <td>
                            {% if user.lastlogin and user.lastlogin > 0 %}
                            {{ user.lastlogin|int|timestamp_to_datetime }}
                            {% else %}
                            Never
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}">Edit</a>
                            {% if user.name.upper() != session.get('username').upper() and user.name.upper() != 'GUEST'
                            %}
                            |
                            <form method="post" action="{{ url_for('admin.delete_user', user_id=user.id) }}"
                                style="display: inline;"
                                onsubmit="return confirm('Are you sure you want to delete user \'{{ user.name }}\'? This action cannot be undone.');">
                                <button type="submit" class="action-link-delete">Delete</button>
                            </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% include 'admin/_pagination.html' %}
    </div>

    {# --- User Activity Tab --- #}
    <div class="tab-pane fade {% if tab == 'activity' %}show active{% endif %}" id="activity" role="tabpanel">
        <p>Displays a summary of user activity, including last login and posting details.</p>

        {% with search_params=search_params, pagination=pagination,
        search_params_for_per_page=search_params_for_per_page
        %}
        {% include 'admin/_pagination.html' %}
        {% endwith %}

        <div class="table-responsive">
            <table class="table" style="margin-top: 1em; margin-bottom: 1em;">
                <thead>
                    <tr>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='activity', sort_by='name', order=next_order if sort_by == 'name' else 'asc', per_page=search_params.per_page) }}">Name
                                {% if sort_by == 'name' %}{{ '▲' if order == 'asc' else '▼' }}{% endif %}</a></th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='activity', sort_by='last_login', order=next_order if sort_by == 'last_login' else 'desc', per_page=search_params.per_page) }}">Last
                                Login {% if sort_by == 'last_login' %}{{ '▲' if order == 'asc' else '▼' }}{% endif
                                %}</a>
                        </th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='activity', sort_by='last_post_time', order=next_order if sort_by == 'last_post_time' else 'desc', per_page=search_params.per_page) }}">Last
                                Post Time {% if sort_by == 'last_post_time' %}{{ '▲' if order == 'asc' else '▼' }}{%
                                endif %}</a></th>
                        <th>Last Post Board</th>
                        <th><a
                                href="{{ url_for('admin.user_management', tab='activity', sort_by='total_posts', order=next_order if sort_by == 'total_posts' else 'desc', per_page=search_params.per_page) }}">Total
                                Posts {% if sort_by == 'total_posts' %}{{ '▲' if order == 'asc' else '▼' }}{% endif
                                %}</a></th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in user_activities %}
                    <tr>
                        <td>{{ activity.name }}</td>
                        <td>{{ activity.last_login|int|timestamp_to_datetime if activity.last_login and
                            activity.last_login > 0 else 'Never' }}</td>
                        <td>{{ activity.last_post_time|int|timestamp_to_datetime if activity.last_post_time else 'N/A'
                            }}</td>
                        <td>{{ activity.last_post_board_name or 'N/A' }}</td>
                        <td>{{ activity.total_posts or 0 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        {% with search_params=search_params, pagination=pagination,
        search_params_for_per_page=search_params_for_per_page
        %}
        {% include 'admin/_pagination.html' %}
        {% endwith %}
    </div>
</div>
{% endblock %}